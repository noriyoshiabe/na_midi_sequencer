V2.1設計
========

用語定義
--------

定義|意味
---|---
NOTE|音符のこと
Quantize|現在選択されている音符の長さ
1step,2step等の表現|Quantize x N 分の長さ

モード一覧
----------
- ノーマルモード
- インサートモード
- コマンドモード

操作仕様
--------

### 共通

キー名|動作概要
---|---
&#039;|次に入力するNOTEを#させる。 E や B など #の黒鍵が無い場合は♮
;|次に入力するNOTEを♭させる。 F や C など ♭の黒鍵が無い場合は♮
&#039;&#039; (&#039; x2)|入力するNOTEを#でロックする。 E や B など #の黒鍵が無い場合は♮
;;|入力するNOTEを♭でロックする。 F や C など ♭の黒鍵が無い場合は♮
=|次に入力するNOTEを♮させる。# or ♭でロックされていない場合はなにもしない
==|# or ♭のロックを解除
>|オクターブシフト (UP)
<|オクターブシフト (DOWN)
→|カーソル右移動(1半音上)
←|カーソル左移動(1半音下)
↑|カーソル上移動(1つ前の小節の頭にスナップ)
↓|カーソル下移動(1つ後ろの小節の頭にスナップ)
数値,c|Channel設定 (1-16の範囲)
数値,m|Mute設定 (1-16の範囲, 0でリセット)
数値,s|Solo設定 (1-16の範囲, 0でリセット)
数値,v|Velocity設定 (0-127の範囲)
数値,q|Quantize設定 \* 下記例参照

例)
```
32, q -> 32分音符
8, q -> 8分音符
4/3, q -> 3連符
8/3 or 4/6, q -> 6連符
4., q -> 符点4分音符
```

### ノーマルモード

#### NOTE
キー名|動作概要
---|---
a b c d e f g a b|ノーマルモードではNOTEのプレビュー 発音のみ

#### モード切り替え
キー名|動作概要
---|---
i|カーソル位置でインサートモードへ
a|1step後からインサートモードへ
o|カーソル位置から1小節分の長さの空白を挿入してインサートモードへ
 :|コマンドモードへ


#### 画面移動
キー名|動作概要
---|---
Ctrl-u|縦に画面半分上がる
Ctrl-d|縦に画面半分下がる
Ctrl-b|縦に1画面分上がる
Ctrl-f|縦に1画面分下がる

#### ヤンク/切り取り

\*基本的にはvimと同様に

キー名|動作概要
---|---
y|ヤンク\*下記の例参照
d|切り取り\*NOTEキーと衝突するのでビジュアル選択中のみ有効
x|カーソル位置の音符を削除してヤンク
Shift+v|ビジュアル行選択の開始
Ctrl-v|ビジュアル矩形選択の開始
p|ペースト<br>- 行選択でヤンクされている場合は小節挿入を伴う<br>- 同一行や矩形選択でヤンクされている場合はカーソル位置から相対で貼り付け

- v で行われる通常のビジュアル選択は実装しない。  Vimの様に行の途中から選択という概念が成り立たないので

例)
```
y, → カーソル位置の1音コピー
y, ← カーソル位置の左の1音コピー
y, ↑ カーソル位置の上1Step分の全音コピー
y, ↓ カーソル位置の1Step分の全音コピー
y, 2, → カーソル位置から右へ2音コピー
y, 2, ← カーソル位置を含まず左へ2音コピー
y, 2 ↑ カーソル行含まず上2Step分の全音コピー
y, 2 ↓ カーソル位置から2Step分の全音コピー
y, Shift+→ カーソル位置から右側の次のCまでコピー
y, Shift+← カーソル位置を含まず左へ次のCまでコピー
y, Shift+↑ カーソル行含まず前or現在小節頭までの全音コピー
y, Shift+↓ カーソル位置から次の小節頭までの全音コピー

  * Ctrl-d Ctrl-uとかも同様に移動した分コピー
```

##### ビジュアル行選択中の動作

キー名|動作概要
---|---
ESC|キャンセル
↓↑|選択行の伸縮
y|選択行をコピー
d|選択行を切り取って詰める
x|選択行の内容を削除、詰めない

##### ビジュアル矩形選択中の動作

キー名|動作概要
---|---
ESC|キャンセル
↓↑←→|選択範囲の伸縮
y|選択範囲をコピー
d|選択範囲を切り取り 矩形選択時は詰めない<br>\* Vimだと左右が詰められるけど、切り取った際に音程が変わるのもおかしいので音程は変えない
x|dと同じ

#### Window操作

キー名|動作概要
---|---
Ctrl-w|Window操作開始
Ctrl-w, CTRL-W|次のWindowに移動
Ctrl-w, ←↑→↓|カーソル方向のWindowに移動
Ctrl-w, +|カレントウィンドウの高さを N 行高くする。
Ctrl-w, -|カレントウィンドウの高さを N 行低くする。
Ctrl-w, <|カレントウィンドウの幅を N 列狭める
Ctrl-w, =|すべてのウィンドウの高さと幅を同じにする。
Ctrl-w, >|カレントウィンドウの幅を N 列広くする。

\* NについてはVimの動作を参考に  
\* その他のWindowコマンドは無くてもいけると思うのでひとまず実装しない


#### その他
キー名|動作概要
---|---
u|Undo
Ctrl+r|redo
1,G|最初の小節まで戻る
100,G|100小節目まで移動
Shift+G|一番最後の音符まで移動
Ctrl-p|再生/停止


### インサートモード

キー名|動作概要
---|---
ESC|ノーマルモードへ
a b c d e f g a b|NOTE入力+1step移動
Shift+NOTEキー|カーソル位置はそのままで音符入力
Delete|カーソル位置のNOTE削除 or Gatetime縮める<br>+カーソル1Step分戻し
Shift+Delete|カーソル位置のNOTE削除 移動なし
Tab|カーソル位置の音符のゲートタイムを伸ばして1Step分進む
Shift+Tab|カーソル行の音符全てののゲートタイムを伸ばして1Step分進む
Space|1step分進む


### コマンドモード

#### 画面分割

定義|動作概要
---|---
`sp[lit]`|上下分割
`vs[plit]`|左右分割

#### 設定系

定義|動作概要
---|---
`set s[ync]`|各Windowの小節位置同期
`set nos[ync]`|各Windowの小節位置同期解除
`set m[eta]`|marker, tempo, beat などのメタイベント列を表示 \*
`set nom[eta]`|メタイベント列を隠す \*
`set (metawidth|mw)=<width>`|メタイベント列の幅設定 \*

\* 表示仕様のメタイベントの表示を参照

#### ファイル系・その他

定義|動作概要|備考
---|---|---
`e[dit] <filename>`|SMF読み込み|サブディレクトリや../で親ディレクトリを読めるように
`w[rite] <filename>`|SMF書き出し|サブディレクトリや../で親ディレクトリを読めるように
`cd <path>`|作業ディレクトリの移動| |
`pwd`|カレントディレクトリの表示| |
`(mo|midiout) [<ポート番号>]`|MIDI出力のポート選択|ポート番号省略で選択可能なポートを表示 \*
`q[uit]`|プログラム終了|未保存であれば警告表示
`h[elp] [<command>]`|ヘルプの表示|Windowを上下分割して上側に表示<br>既に開いてたら分割しない

\* MIDIポートの表示例
```
1) IAC ドライバ バス 1
2) JUNO-G
```

#### 編集系

##### 範囲定義の考え方

`:<開始位置>,<終了位置>,<チャネル>`

###### 開始位置・終了位置
- 1 or 1:1 or 1:1:1  
  それぞれ 小節番号:拍:Tick  
- 終了位置を省略した場合は開始位置の1ステップ分 -> 多分あまり使わない
- 開始位置、終了位置を省略した場合は現在のカーソル位置

###### チャネル
- 省略で全チャネル
- +で複数指定
- -で除外指定
- +と-の同時指定は不可


例)
```
# 先頭のコロンはコマンド開始のコロン

:1:3,2:3:240,9 # 小節1の3拍目〜小節1の3拍目+8分音符のチャネル9
:1,100 # 小節1〜小節100の全チャネル
:1,100,9+10 # 小節1〜小節100の9,10チャネル
:1,100,9+10+11 # 小節1〜小節100の9,10,11チャネル
:1,100,-9 # 小節1〜小節100の9以外の全チャネル
:1,100,-9-10 # 小節1〜小節100の9,10以外の全チャネル
:1,100,-9+10 # +-同時指定不可。エラーメッセージを表示
```

###### ビジュアル選択時の動作

- ビジュアル選択から':'でコマンド入力開始した場合は、範囲入力をアシストする
- Vimみたいに'<,'>のような制御文字を入れるのは大変なので絶対値を入れてしまう
- 矩形選択の場合は、音程の範囲は無視でポジションのみ入力アシスト -> Vimも同様な動き

##### 編集コマンド

定義|動作概要|備考
---|---|---
`<範囲> t[ranspose]=<value>`|トランスポーズ|-127~127<br>結果が0~127の範囲を出たら丸める
`<範囲> v[elocity]=<value>`|Velocity一括指定|0~127
`<範囲> g[atetime]=<value>`|GateTime一括指定|通常のgatetime(4分音符480分解能)の値で入力
`<範囲> e[rase]`|消去(後ろの音符の位置を詰めない)| |
`<範囲> d[elete]`|削除(後ろの音符の位置を詰める)|チャネル指定不可
`<範囲> i[nsert]=<空白の長さ>`|空白挿入|- 空白の長さは1で1小節、1:1:240で1小節+1拍+8分音符分<br>- 1小節の長さは範囲の開始位置の拍子を基準に<br>- 範囲の終了位置とチャネルの指定は不可
`<範囲> c[opy]=<コピー先開始位置>[,コピー先チャネル]`|コピー| |
`<範囲> m[ove]=<移動先開始位置>[,移動先チャネル]`|移動| |

#### プログラムチェンジ、メタイベント

範囲の考え方にI/Fをあわせているけど、ほぼ別物

定義|動作概要
---|---
`<位置> p[rogram]=<channel>,<msb>,<lsb>,<number>`|音色変更イベント
`<小節NO> b[eat]=N/N`|拍子イベント
`<小節NO> (tempo|tm)=<tempo>`|テンポイベント
`<位置> (marker|mk)=<text>`|マーカー

\* それぞれ、= の後ろになにも指定が無い場合は指定位置のイベントを消去

### 表示仕様

#### 画面構成
```
+---------------------------+
|                           | ←ターミナルアプリのタイトルバー
+===========================+
|                           | ←編集エリア(分割される)
|                           |
|                           |
|                           |
|                           |
|                           |
+---------------------------+ ← ステータスライン
|                           | ← コマンドエリア
+---------------------------+
```

#### ターミナルアプリのタイトルバー
- プログラム名と編集中のファイル名を表示  
  `namidi:./hogedir/hogefile.mid`
- 新規作成時は[noname]  
  `namidi:[noname]`
- プログラム終了時に戻す

#### 編集エリア
##### 基本
```
 ↓カーソル位置のポジション値
+----------------------------------------+
|001:01:000 |0   1           2           | → オクターブ番号、一番左は常に表示
|           |*A*BC*D*EF*G*A*BC*D*EF*G*A*B| → オクターブ設定に応じて有効なノート(Aとか)の文字色を変える
|========================================| 
|001:01:000 |''''x''''''''''''x''''''''''|
|001:01:240 |                            |
|001:02:000 |    x     x                 |
|001:02:240 |          x                 |
|001:03:000 |        x x                 |
|001:03:240 |          x                 |
|001:04:000 |    x     x                 |
|001:04:240 |        x x                 |
|002:01:000 |''''x'''''x'''''''''''''''''|
|002:01:240 |          x                 |
|002:02:000 |    x     x                 |
|002:02:240 |          x                 |
|002:03:000 |        x x                 |
|002:03:240 |          x                 |
|002:04:000 |    x     x                 |
|002:04:240 |        x x                 |
+----------------------------------------+
```

- 左右にはスケールアップ/スケールダウンしない
- 上下のスケールは現在のQuantize設定と1小節の最大公約数を最小単位にして自動的に変える  
  \* Quantizeと分離したキー入力でのズームスケール変更は実装しない


##### メタイベントの表示
`set meta` `set nometa` などで表示/非表示切り替え

```
              ↓ カーソル位置のテンポ・拍子
+-----------------------------------------------------+
|001:01:000 |120.00      |0   1           2           |
|           |4/4         |*A*BC*D*EF*G*A*BC*D*EF*G*A*B|
|=====================================================|
|001:01:000 |4/4'''''''''|''''x''''''''''''x''''''''''|
|001:01:240 | + 120.0    |                            | →メタイベントが次のStepでも連続することはあまりないと思うので
|001:02:000 | + Intro    |    x     x                 |   同じ位置に集中していたら下に表示してしまう
|001:02:240 | + PC       |          x                 |
|001:03:000 |   0,0,127  |        x x                 | →プログラムチェンジはメタイベントでは無いけど、イベントリスト実装までは
|001:03:240 |            |          x                 |   表示する場所が無いのでMETA列にいっしょに表示してしまう
|001:04:000 |            |    x     x                 |   ただし、Channelを持っているので各チャネルごとに表示
|001:04:240 |            |        x x                 |   その他のメタイベントは全Channelで共通
|002:01:000 |140.0'''''''|''''x'''''x'''''''''''''''''|
|002:01:240 |            |          x                 |
|002:02:000 |            |    x     x                 |
|002:02:240 |            |          x                 |
|002:03:000 |            |        x x                 |
|002:03:240 |            |          x                 |
|002:04:000 |            |    x     x                 |
|002:04:240 |            |        x x                 |
+-----------------------------------------------------+
```

#### ステータスライン
画面分割時はそれぞれのWindowにステータスラインを表示する
```
+---------------------------+
|             |             |
|             |             |
|             | ↓          |
|             |-------------|
|             |             |
|             |             |
| ↓          | ↓          |
+-------------+-------------+
|                           |
+---------------------------+
```

##### 表示内容
- チャネルNo
- Verocity設定
- Quantize設定
- 音色名
- ミュート
- ソロ

例)
```
# Mute/Soloは大文字がON
----------------------------------------------
CH:10 [M][s] V:127 Q:1/8 [Electric Bass(pick)]
----------------------------------------------
```

#### コマンドエリア

- v2でやっている中途半端な定義補完は廃止
- TABでのコマンド候補一覧と補完の動作は極力Vimに合わせる
- ファイル読み込み/書き込み時のファイル名補完もVim同様に
- キー名のエコー出力は廃止 => カスタマイズ可能なキーはhelpに

##### コマンド入力以外の情報表示
- 複合キー入力時のエコー  
  \* 4/3, q -> 3連符 の場合、qで確定される前、4/3の表示  
  \* なるべくVim同様に
- メッセージ
- 再生中の再生位置
- インサートモード中の -- Insert -- 表示

例)
```
# インサートモードで3連符指定する際に'q'で確定する前
-----------------------------------------
-- Insert --                      4/3
-----------------------------------------

# 再生中 かつ 複合キー入力中じゃない
-----------------------------------------
                           012:02:000
-----------------------------------------
```


設定ファイル(.namidirc)
-----------------------
- キーのカスタマイズはnnoremap,inoremap,noremap,vnoremap で行う(大変そうだけど)  
  例) `inoremap h 'f` -> インサートモード h キーでF#  '
- noremapじゃないmap系はわけわからなくなりそうなので実装しない
- .vimrc同様、コマンド入力互換

\* 必要な設定は適宜出てくると思うので、その都度コマンドに追加


アーキテクチャ設計
-----------------
TODO: Window管理・キー入力・メインループ・UIスレッドなど

パッケージ構成
--------------
TODO

クラス設計
----------
TODO

