# NA MIDI Sequencer オペレーションマニュアル

## はじめに
NA MIDI Sequencer はターミナルから使用するGUIのMIDIシーケンサーです。
設計思想としてシンプルなデータ構造と打ち込みのしやすさにフォーカスし、楽曲を作りこむことより素早くプロトタイプを作成できることを主眼に置いています。
楽曲を作りこむ際は、出力したStandard MIDI Fileを他のDAWに取り込んで編集することを想定しています。
前述の理由と、Standard MIDI Fileとの親和性から、データ構造が複雑になるパターンシーケンサーとしての機能は一切捨てました。


## 基本的な流れ
0. アプリ起動
0. **'r'** キーで**RECモード**に
0. キーボードで音符を入力/編集
0. **CTRL-P** で再生/停止
0. **:** キーで**コマンド入力モード**に
0. `write hoge.mid` でSMFに保存
0. **CTRL-Q**でアプリ終了
0. 次回アプリ起動
0. **:** キーで**コマンド入力モード**に
0. `read hoge.mid` でSMFを読み込む


## 画面構成
### 小節View
画面上部は現在のポジションや各小節の拍子・テンポ・マーカーなどを表示します。

### トラックView
画面中央の上半分と下半分の2トラック固定で表示します。  
トラックの切り替えは**CTRL-T**で、現在トラックのchannel切り替えは**コマンド入力モード**で`channel <channel>` を入力して切り替えます。

### ステータスView
画面下部の青いラインに現在の録音モードやchannel・quantize(入力時の音符の長さ)・velocity(音の大きさ)などを表示します。

### コマンドView
**コマンド入力モード**で使用します。


## 移動
- **←↑→↓**の矢印キーでカーソルを移動します。
- **SHIFT**を押しながら**←→**で小節移動になります。
- **CTRL-D** **CTRL-U**で音階を１オクターブ分移動します。  
  \* ターミナルで**SHIFT+↑↓**の検知ができないためこうなっています。_
- **CTRL-W**で最初の小節まで戻ります。
- **SPACE**で休符入力となりカーソルが進みます。


## モード説明
アプリ起動時は**PREVIEWモード**になっています。
**'r'**キーで**RECモード**とトグルで切り替わります。

### PREVIEWモード
音階キー入力時に音符入力は行わず、発音のみします。
音符のタイや削除、Undo/Redoなどは可能です。

### RECモード
音階キー入力時に音符入力を行います。
単音入力用の**REC-NOTEモード**と和音入力用の**REC-CHORDモード**とがあります。  
**REC-NOTEモード**と**REC-CHORDモード**は**CTRL-C**で切り替えます。

_\* REC-CHORDモードはもともと用意するつもりは無かったのですが、ターミナルではキーアップのイベントが取れず、和音入力と単音入力を同時押しかどうかで判断できないので仕方なくこのモードを作りました。_

#### REC-NOTEモード
- 音階キーを入力すると対応する音符が入力され、quantizeの長さ分、カーソルが進みます。
- 続けて**TAB**キーを入力するとquantizeの長さ分、音符のgatetime(長さ)を伸ばします。(タイ)
- **DELETE**キーを入力すると、現在のカーソル一位置の音符のgatetimeを縮めてカーソルを戻します。
- 音符のgatetimeがquantize以下の場合は、音符を削除します。
- **fn+DELETE**キーを入力すると、gatetimeにかかわらず現在位置の音符を削除します。カーソル位置は変化しません。

_\* 通常はREC-NOTEモードで適切なquantizeを設定し、音階キーで音符入力、伸ばす必要があればTABで伸ばす。休符を入れたい場合はSPACEで進めながら打ち込んでいく流れになります。_

#### REC-CHORDモード
- 音階キーを入力しても**ENTER**が入力されるまでは音符入力を行いません。
- 必要な和音の全ての音階キーを入力後、**ENTER**を入力すると、音符が入力されquantizeの長さ分、カーソルが進みます。
- **TAB**キー、**DELETE**キー、**fn+DELETE**キーを入力した場合、カーソル位置の音符だけでなく、そのポジションの全ての音符のgatetime変更、もしくは削除を行います。

_\* PREVIEWモードとRECモードの基本的な違いは音符入力するかどうかです。その他の機能キーは同様に動作します。_


### コマンド入力モード
**':'** キーでコマンド入力モードになります。
小節のコピーや、挿入、移動などを行います。  
詳細はリファレンスを参照。

_\* コマンド入力中、TABキーで補完、↑↓でヒストリーの参照が可能ですが、どちらも簡易的な実装です。_


## リファレンス

### キーボード
#### 機能キー

キー名|機能概要
---|---
CTRL-Q|アプリ終了
→|カーソル右移動
←|カーソル左移動
↑|カーソル上移動(１半音上)
↓|カーソル下移動(１半音下)
SHIFT-→|次の小節へ移動
SHIFT-←|前の小節へ移動
CTRL-W|最初の小節まで戻る
CTRL-U|カーソルを１オクターブ上に移動
CTRL-D|カーソルを１オクターブ下に移動
u|Undo
CTRL-R|Redo
TAB|タイ
DELETE|gatetimeを縮める or 音符の削除
fn+DELETE|音符の削除
SPACE|休符入力(カーソルを進める)
>|オクターブシフト (UP)
<|オクターブシフト (DOWN)
ALT+.|クオンタイズ (UP)
ALT+,|クオンタイズ (DOWN)
4|クオンタイズ 1/4
8|クオンタイズ 1/8
6|クオンタイズ 1/16
3|クオンタイズ 1/32
CTRL-P|再生/停止
r|PREVIEWモード/RECモード切り替え
CTRL-C|REC-NOTEモード/REC-CHORDモード切り替え
ENTER|REC-CHORDモードでの音符入力決定
 :|コマンド入力モード
+|ズームスケール変更(zoom up)
-|ズームスケール変更(zoom down)
=|ズームスケール変更(default)
CTRL-T|トラック切り替え


#### 音階キー

キーボードのCの位置を基準に鍵盤に見立てています。  
**SHIFT**を押しながらの入力で１オクターブ上の音階を鳴らします。

キー名|音階
---|---
z|A
s|A#
x|B
c|C
f|C#
v|D
g|D#
b|E
n|F
j|F#
m|G
k|G#
,|A
l|A#
.|B
/|C
Z|A (１オクターブ上)
S|A# (１オクターブ上)
X|B (１オクターブ上)
C|C (１オクターブ上)
F|C# (１オクターブ上)
V|D (１オクターブ上)
G|D# (１オクターブ上)
B|E (１オクターブ上)
N|F (１オクターブ上)
J|F# (１オクターブ上)
M|G (１オクターブ上)
K|G# (１オクターブ上)


### コマンド

#### position
`position <measure_no> [<beat>] [<tick>]`

指定位置へ移動します。

パラメータ|必須|説明
---|:---:|---
measure_no|○|小節No
beat| |拍
tick| |ー拍の中の位置(分解能480)

#### channel
`channel <channel>`

現在のトラックのchannelを切り替えます。

パラメータ|必須|説明
---|:---:|---
channel|○|channel

#### velocity
`velocity <velocity>`

音符入力時のvelocityを変更します。

パラメータ|必須|説明
---|:---:|---
velocity|○|velocity

#### tempo
`tempo <measure> <tempo>`

指定小節にテンポチェンジを設定します。

パラメータ|必須|説明
---|:---:|---
measure|○|小節No
tempo|○|テンポ (小数点第２位まで指定可)

#### beat

指定小節に拍子変更を設定します。
`beat <measure> <N/N>`

パラメータ|必須|説明
---|:---:|---
measure|○|小節No
N/N|○|拍子(例 3/4 の形式で指定)

_\* 通常使われないような無理な値はテストしていません_

#### marker
`marker <measure> <text>`

指定小節にマーカーを設定します。

パラメータ|必須|説明
---|:---:|---
measure|○|小節No
text|○|任意のテキスト<br/>\* クォーテーションで括ればスペースも可<br/>\* マルチバイト文字非対応

#### copy
`copy <from> <length> <to> [<channel>] [<channel_to>]`

指定範囲の音符をコピーします。

パラメータ|必須|説明
---|:---:|---
from|○|コピー元開始小節No
length|○|コピー元範囲の小節数
to|○|コピー先の開始小節数
channel| |コピー対象のchannel<br/>\* 未指定の場合、全channel
channel_to| |コピー先のchannel<br/>\* 未指定の場合、channelの指定と同じ

#### move
`move <from> <length> <to> [<channel>] [<channel_to>]`

指定範囲の音符を移動します。

パラメータ|必須|説明
---|:---:|---
from|○|移動元開始小節No
length|○|移動元範囲の小節数
to|○|移動先の開始小節数
channel| |移動対象のchannel<br/>\* 未指定の場合、全channel
channel_to| |移動先のchannel<br/>\* 未指定の場合、channelの指定と同じ

#### erase
`erase <from> <length> [<channel>]`

指定範囲の音符を削除します。

パラメータ|必須|説明
---|:---:|---
from|○|開始小節No
length|○|削除範囲の小節数
channel| |削除対象のchannel<br/>\* 未指定の場合、全channel

#### delete
`delete <from> <length>`

指定範囲の小節を削除して詰めます。

パラメータ|必須|説明
---|:---:|---
from|○|開始小節No
length|○|削除範囲の小節数

#### insert
`insert <from> <length>`

指定位置に空の小節を挿入します。

パラメータ|必須|説明
---|:---:|---
from|○|挿入先小節No
length|○|挿入する小節数

#### read
`read <filename>`

Standard MIDI Fileを読み込みます。  
現在の編集内容は消去されます。

パラメータ|必須|説明
---|:---:|---
filename|○|ファイル名<br/>\* '/' でサブディレクトリ指定可

#### write
`write <filename>`

編集内容をStandard MIDI Fileに書き込みます。  

パラメータ|必須|説明
---|:---:|---
filename|○|ファイル名<br/>\* '/' でサブディレクトリ指定可

#### program
`program <channel> <msb> <lsb> <number>`

指定channelの音色を変更します。  
_\* 内部的にはMIDI音源にバンクセレクト・プログラムチェンジを送信するのみで、指定小節への音色変更イベントには非対応です。_

パラメータ|必須|説明
---|:---:|---
channel|○|channel
msb|○|バンクセレクトメッセージのMSB
lsb|○|バンクセレクトメッセージのLSB
number|○|プログラムチェンジメッセージのプログラムNo

#### quit
`quit`

アプリを終了します。


## 設定ファイル

### key_mapping.yml
キーマップはkey_mapping.ymlを編集してカスタマイズできます。  
キー名の右側に定義されているコマンド名と値はアプリで参照しています。  
間違った値になっていると正常に動作しないため注意して下さい。  
キー名の定義はアプリの画面右下にエコーされるキー名を参考にして下さい。

### settings.yml

定義名|概要
---|---
documents|SMFを保存するディレクトリ
history_size|コマンドヒストリーに残す件数
defaults|アプリ起動時の初期値
+ noteno|カーソルの音階
+ channel_1|トラック1のchannel
+ channel_2|トラック2のchannel
+ quantize|変更する場合はcurses/sequencer/app/models/editor.rbの定義を参照
+ velocity|velocityのデフォルト値
+ octave|octaveのデフォルト値
instruments|起動時にMIDI音源に送信する音色設定<br/>
+ ch_0~15|音色名の定義はinstruments.yml参照

### instruments.yml
settings.yml で定義しているinstrumentsの設定と対応付けます。  
アプリ起動時にMIDI音源に送信するバンクセレクトのMSB・LSB、プログラムチェンジのプログラムナンバーを設定します。  
基本的に、General MIDIの定義に順処しています。  
DLSMusicDeviceを使用する場合は、特に変更の必要はありません。


## Standard MIDI File 対応状況
書き込み/読み込みともにフォーマット１のみサポートします。  
その他の対応しているMIDIイベントは以下に限定し、その他のイベントには非対応です。

MIDIイベント|ステータス|メタイベント|制限
---|---|---|---
ノートオン|9n|-| |
ノートオフ|8n|-| |
マーカー|FF|06|マルチバイト文字非対応
トラック終端|FF|2F| |
テンポ設定|FF|51|小節途中のテンポ変更不可<br/>\* 読み込み時は小節先頭に丸めます
拍子の設定|FF|58|小節途中の拍子変更不可<br/>\* 読み込み時は小節先頭に丸めます

